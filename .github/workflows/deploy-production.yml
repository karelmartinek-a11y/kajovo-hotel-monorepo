name: Deploy - hotel.hcasc.cz

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI Full - Kájovo Hotel"]
    types:
      - completed
    branches:
      - main

permissions: {}

jobs:
  deploy-decision:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decide.outputs.should_deploy }}
      reason: ${{ steps.decide.outputs.reason }}
    steps:
      - id: decide
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            echo "reason=Manual workflow_dispatch trigger." >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event.workflow_run.conclusion }}" = "success" ] && [ "${{ github.event.workflow_run.head_branch }}" = "main" ]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            echo "reason=CI Full finished successfully on main." >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
            echo "reason=CI Full conclusion='${{ github.event.workflow_run.conclusion }}' on branch='${{ github.event.workflow_run.head_branch }}'; deploy requires success on main." >> "$GITHUB_OUTPUT"
          fi
      - name: Deployment decision summary
        shell: bash
        run: |
          echo "### Deploy decision" >> "$GITHUB_STEP_SUMMARY"
          echo "- should_deploy: \`${{ steps.decide.outputs.should_deploy }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- reason: ${{ steps.decide.outputs.reason }}" >> "$GITHUB_STEP_SUMMARY"
  deploy-production:
    needs: deploy-decision
    if: needs.deploy-decision.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Připrav SSH klíč
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.HOTEL_DEPLOY_KEY }}
        run: |
          if [ -z "$DEPLOY_KEY" ]; then
            echo "Chybí secret HOTEL_DEPLOY_KEY" >&2
            exit 1
          fi
          if grep -q "BEGIN .*PRIVATE KEY" <<<"$DEPLOY_KEY"; then
            printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          else
            echo "$DEPLOY_KEY" | base64 -d > deploy_key.pem || printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          fi
          chmod 600 deploy_key.pem
          ssh-keygen -lf deploy_key.pem || true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOTEL_DEPLOY_HOST }}
          username: ${{ secrets.HOTEL_DEPLOY_USER }}
          key_path: deploy_key.pem
          port: ${{ secrets.HOTEL_DEPLOY_PORT }}
          script: |
            set -euo pipefail
            SSH_CMD="ssh -i /root/.ssh/deploy_kajovo_hotel_monorepo -o IdentitiesOnly=yes"
            if [ ! -d /opt/kajovo-hotel-monorepo/.git ]; then
              GIT_SSH_COMMAND="$SSH_CMD" git clone git@github.com:karelmartinek-a11y/kajovo-hotel-monorepo.git /opt/kajovo-hotel-monorepo
            fi
            git -C /opt/kajovo-hotel-monorepo config --global --add safe.directory /opt/kajovo-hotel-monorepo
            git -C /opt/kajovo-hotel-monorepo config core.sshCommand "$SSH_CMD"
            /opt/kajovo-hotel-monorepo/infra/ops/deploy-production.sh
