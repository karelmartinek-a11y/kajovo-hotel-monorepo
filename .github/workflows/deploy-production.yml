name: Deploy - hotel.hcasc.cz

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI Full - Kájovo Hotel"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: deploy-hotel-hcasc-production
  cancel-in-progress: true

permissions: {}

jobs:
  deploy-production:
    if: github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    environment: production
    env:
      HOTEL_DEPLOY_KEY: ${{ secrets.HOTEL_DEPLOY_KEY != '' && secrets.HOTEL_DEPLOY_KEY || vars.HOTEL_DEPLOY_KEY }}
      HOTEL_DEPLOY_PASS: ${{ secrets.HOTEL_DEPLOY_PASS != '' && secrets.HOTEL_DEPLOY_PASS || vars.HOTEL_DEPLOY_PASS }}
      HOTEL_ADMIN_EMAIL: ${{ secrets.HOTEL_ADMIN_EMAIL != '' && secrets.HOTEL_ADMIN_EMAIL || vars.HOTEL_ADMIN_EMAIL }}
      HOTEL_ADMIN_PASSWORD: ${{ secrets.HOTEL_ADMIN_PASSWORD != '' && secrets.HOTEL_ADMIN_PASSWORD || vars.HOTEL_ADMIN_PASSWORD }}
    steps:
      - name: Připrav SSH klíč
        if: ${{ env.HOTEL_DEPLOY_KEY != '' }}
        shell: bash
        env:
          DEPLOY_KEY: ${{ env.HOTEL_DEPLOY_KEY }}
        run: |
          if [ -z "$DEPLOY_KEY" ]; then
            echo "Chybí secret HOTEL_DEPLOY_KEY" >&2
            exit 1
          fi
          if grep -q "BEGIN .*PRIVATE KEY" <<<"$DEPLOY_KEY"; then
            printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          else
            echo "$DEPLOY_KEY" | base64 -d > deploy_key.pem || printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          fi
          chmod 600 deploy_key.pem
          ssh-keygen -lf deploy_key.pem || true

      - name: Deploy via SSH (key)
        if: ${{ env.HOTEL_DEPLOY_KEY != '' }}
        id: deploy-key
        continue-on-error: true
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOTEL_DEPLOY_HOST != '' && secrets.HOTEL_DEPLOY_HOST || vars.HOTEL_DEPLOY_HOST }}
          username: ${{ secrets.HOTEL_DEPLOY_USER != '' && secrets.HOTEL_DEPLOY_USER || vars.HOTEL_DEPLOY_USER }}
          key_path: deploy_key.pem
          port: ${{ secrets.HOTEL_DEPLOY_PORT != '' && secrets.HOTEL_DEPLOY_PORT || vars.HOTEL_DEPLOY_PORT }}
          envs: HOTEL_ADMIN_EMAIL,HOTEL_ADMIN_PASSWORD
          script: |
            set -euo pipefail
            set -x
            SSH_CMD="ssh -i /root/.ssh/deploy_kajovo_hotel_monorepo -o IdentitiesOnly=yes"
            if [ ! -d /opt/kajovo-hotel-monorepo/.git ]; then
              GIT_SSH_COMMAND="$SSH_CMD" git clone git@github.com:karelmartinek-a11y/kajovo-hotel-monorepo.git /opt/kajovo-hotel-monorepo
            fi
            git -C /opt/kajovo-hotel-monorepo config --global --add safe.directory /opt/kajovo-hotel-monorepo
            git -C /opt/kajovo-hotel-monorepo config core.sshCommand "$SSH_CMD"
            git -C /opt/kajovo-hotel-monorepo reset --hard HEAD
            git -C /opt/kajovo-hotel-monorepo clean -fd
            GIT_SSH_COMMAND="$SSH_CMD" git -C /opt/kajovo-hotel-monorepo fetch --prune origin
            git -C /opt/kajovo-hotel-monorepo checkout main
            git -C /opt/kajovo-hotel-monorepo reset --hard origin/main
            if [ -n "${HOTEL_ADMIN_EMAIL:-}" ]; then export KAJOVO_API_ADMIN_EMAIL="$HOTEL_ADMIN_EMAIL"; fi
            if [ -n "${HOTEL_ADMIN_PASSWORD:-}" ]; then export KAJOVO_API_ADMIN_PASSWORD="$HOTEL_ADMIN_PASSWORD"; fi
            set +e
            /opt/kajovo-hotel-monorepo/infra/ops/deploy-production.sh
            DEPLOY_STATUS=$?
            cd /opt/kajovo-hotel-monorepo
            export COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-kajovo-prod}
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml ps -a
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs api --tail=300 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs postgres --tail=80 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs admin --tail=50 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs web --tail=50 || true
            exit "$DEPLOY_STATUS"

      - name: Deploy via SSH (password)
        if: ${{ env.HOTEL_DEPLOY_PASS != '' && (env.HOTEL_DEPLOY_KEY == '' || steps.deploy-key.outcome == 'failure') }}
        id: deploy-password
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOTEL_DEPLOY_HOST != '' && secrets.HOTEL_DEPLOY_HOST || vars.HOTEL_DEPLOY_HOST }}
          username: ${{ secrets.HOTEL_DEPLOY_USER != '' && secrets.HOTEL_DEPLOY_USER || vars.HOTEL_DEPLOY_USER }}
          password: ${{ env.HOTEL_DEPLOY_PASS }}
          port: ${{ secrets.HOTEL_DEPLOY_PORT != '' && secrets.HOTEL_DEPLOY_PORT || vars.HOTEL_DEPLOY_PORT }}
          envs: HOTEL_ADMIN_EMAIL,HOTEL_ADMIN_PASSWORD
          script: |
            set -euo pipefail
            set -x
            if [ ! -d /opt/kajovo-hotel-monorepo/.git ]; then
              git clone git@github.com:karelmartinek-a11y/kajovo-hotel-monorepo.git /opt/kajovo-hotel-monorepo
            fi
            git -C /opt/kajovo-hotel-monorepo config --global --add safe.directory /opt/kajovo-hotel-monorepo
            git -C /opt/kajovo-hotel-monorepo reset --hard HEAD
            git -C /opt/kajovo-hotel-monorepo clean -fd
            git -C /opt/kajovo-hotel-monorepo fetch --prune origin
            git -C /opt/kajovo-hotel-monorepo checkout main
            git -C /opt/kajovo-hotel-monorepo reset --hard origin/main
            if [ -n "${HOTEL_ADMIN_EMAIL:-}" ]; then export KAJOVO_API_ADMIN_EMAIL="$HOTEL_ADMIN_EMAIL"; fi
            if [ -n "${HOTEL_ADMIN_PASSWORD:-}" ]; then export KAJOVO_API_ADMIN_PASSWORD="$HOTEL_ADMIN_PASSWORD"; fi
            set +e
            /opt/kajovo-hotel-monorepo/infra/ops/deploy-production.sh
            DEPLOY_STATUS=$?
            cd /opt/kajovo-hotel-monorepo
            export COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-kajovo-prod}
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml ps -a
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs api --tail=300 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs postgres --tail=80 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs admin --tail=50 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs web --tail=50 || true
            exit "$DEPLOY_STATUS"

      - name: Vyhodnocení deploye
        if: ${{ always() }}
        shell: bash
        run: |
          key_outcome="${{ steps.deploy-key.outcome }}"
          pass_outcome="${{ steps.deploy-password.outcome }}"
          if [ "$key_outcome" = "success" ] || [ "$pass_outcome" = "success" ]; then
            echo "Deploy proběhl úspěšně (key=$key_outcome, password=$pass_outcome)."
            exit 0
          fi
          echo "Deploy selhal (key=$key_outcome, password=$pass_outcome)." >&2
          exit 1
