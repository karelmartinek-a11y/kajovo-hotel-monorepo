name: Deploy - hotel.hcasc.cz

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI Full - Kájovo Hotel"]
    types:
      - completed
    branches:
      - main

permissions: {}

jobs:
  deploy-production:
    if: github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Připrav SSH klíč
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.HOTEL_DEPLOY_KEY }}
        run: |
          if [ -z "$DEPLOY_KEY" ]; then
            echo "Chybí secret HOTEL_DEPLOY_KEY" >&2
            exit 1
          fi
          if grep -q "BEGIN .*PRIVATE KEY" <<<"$DEPLOY_KEY"; then
            printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          else
            echo "$DEPLOY_KEY" | base64 -d > deploy_key.pem || printf '%b' "$DEPLOY_KEY" > deploy_key.pem
          fi
          chmod 600 deploy_key.pem
          ssh-keygen -lf deploy_key.pem || true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOTEL_DEPLOY_HOST }}
          username: ${{ secrets.HOTEL_DEPLOY_USER }}
          key_path: deploy_key.pem
          port: ${{ secrets.HOTEL_DEPLOY_PORT }}
          script: |
            set -euo pipefail
            set -x
            SSH_CMD="ssh -i /root/.ssh/deploy_kajovo_hotel_monorepo -o IdentitiesOnly=yes"
            if [ ! -d /opt/kajovo-hotel-monorepo/.git ]; then
              GIT_SSH_COMMAND="$SSH_CMD" git clone git@github.com:karelmartinek-a11y/kajovo-hotel-monorepo.git /opt/kajovo-hotel-monorepo
            fi
            git -C /opt/kajovo-hotel-monorepo config --global --add safe.directory /opt/kajovo-hotel-monorepo
            git -C /opt/kajovo-hotel-monorepo config core.sshCommand "$SSH_CMD"
            git -C /opt/kajovo-hotel-monorepo reset --hard HEAD
            git -C /opt/kajovo-hotel-monorepo clean -fd
            set +e
            /opt/kajovo-hotel-monorepo/infra/ops/deploy-production.sh
            DEPLOY_STATUS=$?
            cd /opt/kajovo-hotel-monorepo
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml ps -a
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs api --tail=300 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs postgres --tail=80 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs admin --tail=50 || true
            docker compose -f infra/compose.prod.yml -f infra/compose.prod.hotel-hcasc.yml logs web --tail=50 || true
            exit "$DEPLOY_STATUS"
