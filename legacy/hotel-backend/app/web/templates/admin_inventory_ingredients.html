{% extends "base.html" %}

{% set use_sidebar = true %}

{% block sidebar %}
  {% include "admin_sidebar.html" %}
{% endblock %}
{% set inventory_base_path = inventory_base_path|default('/admin/inventory') %}
{% set inventory_media_base = inventory_media_base|default('/admin/inventory/media') %}
{% set readonly = readonly|default(false) %}
{% set show_admin_sidebar = show_admin_sidebar|default(true) %}
{% set back_url = back_url|default('') %}

{% block title %}KájovoHotel — Skladové hospodářství (Správa surovin){% endblock %}

{% block head_extra %}{% endblock %}

{% block body_content %}
<div class="page">
  <div class="container admin-shell">
    {% if show_admin_sidebar %}
      {% include "admin_sidebar.html" %}
    {% endif %}

    <main class="admin-main">
      <div class="stack" style="gap:14px;">
        {% if back_url %}
          <div class="rowline">
            <a href="{{ back_url }}" class="btn">Zpět</a>
          </div>
        {% endif %}
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div style="font-size:20px;font-weight:850;">Skladové hospodářství</div>
          <div style="color:var(--muted);">Suroviny pro snídaně + příjmové/výdajové karty.</div>
        </div>

        <div class="rowline" style="gap:10px;">
          <a href="{{ inventory_base_path }}/ingredients" class="btn {% if inventory_section=='ingredients' %}solid{% endif %}">SPRÁVA SUROVIN</a>
          <a href="{{ inventory_base_path }}/stock" class="btn {% if inventory_section=='stock' %}solid{% endif %}">STAV SKLADU</a>
          <a href="{{ inventory_base_path }}/movements" class="btn {% if inventory_section=='movements' %}solid{% endif %}">POHYBY NA SKLADU</a>
        </div>

        <section class="card pad">
          <div style="display:flex;justify-content:space-between;align-items:baseline;gap:10px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:850;">Správa surovin</div>
              <div class="mini" style="margin-top:4px;">Množství na skladě je interně vedeno v základní jednotce: <span class="pill">kg → g</span> <span class="pill">l → ml</span>.</div>
            </div>
            <div class="rowline">
              <input class="input" id="ingredient-search" placeholder="Hledat surovinu..." />
              <button class="btn" type="button" onclick="window.print()">Tisknout seznam</button>
            </div>
          </div>

          {% if not readonly %}
            <div style="margin-top:12px;border:1px solid rgba(15,23,42,0.08);border-radius:12px;padding:12px;">
              <div style="font-weight:850;">Nová surovina</div>
              <form method="post" action="{{ inventory_base_path }}/ingredient/create" class="rowline" style="margin-top:10px;" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <div style="flex:1;min-width:180px;">
                  <div class="label">Název</div>
                  <input class="input" name="name" placeholder="Např. Mléko" required />
                </div>
                <div style="min-width:120px;">
                  <div class="label">Jednotka</div>
                  <select class="input" name="unit">
                    {% for u in units %}
                      <option value="{{ u }}">{{ u }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div style="min-width:160px;">
                  <div class="label">1 ks (g/ml/ks)</div>
                  <input class="input" name="amount_per_piece_base" type="number" min="0" step="1" value="0" />
                </div>
                <div style="min-width:200px;">
                  <div class="label">Ikona (piktogram)</div>
                  <input class="input" type="file" name="pictogram" accept="image/*" style="max-width:100%;" />
                </div>
                <div style="min-width:120px;">
                  <button class="btn solid" type="submit" style="margin-top:22px;">Přidat</button>
                </div>
              </form>
            </div>
          {% endif %}

          <div style="overflow:auto;margin-top:12px;">
            <table class="ingredients-table">
              <thead>
                <tr>
                  <th style="width:46px;">Ikona</th>
                  <th>Název</th>
                  <th style="width:110px;">Jednotka</th>
                  <th style="width:140px;">1 ks (g/ml/ks)</th>
                  <th style="width:150px;">Sklad</th>
                  <th style="width:260px;">Akce</th>
                </tr>
              </thead>
              <tbody>
                {% for ing in ingredients %}
                  <tr class="ingredient-row" data-search="{{ (ing.name ~ ' ' ~ ing.unit.value)|lower }}">
                    <td>
                      {% if ing.pictogram_thumb_path %}
                        <img class="img" src="{{ inventory_media_base }}/{{ ing.id }}/thumb" alt="Piktogram" loading="lazy" />
                      {% else %}
                        <div class="img" style="display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:900;">•</div>
                      {% endif %}
                    </td>
                    <td>
                      <form method="post" action="{{ inventory_base_path }}/ingredient/{{ ing.id }}/update" class="rowline" style="margin:0;" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <input class="input ingredient-field" name="name" value="{{ ing.name }}" style="min-width:180px;" disabled />
                    </td>
                    <td>
                        <select class="input ingredient-field" name="unit" style="min-width:90px;" disabled>
                          {% for u in units %}
                            <option value="{{ u }}" {% if ing.unit.value == u %}selected{% endif %}>{{ u }}</option>
                          {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input class="input ingredient-field" name="amount_per_piece_base" type="number" min="0" step="1" value="{{ ing.amount_per_piece_base or 0 }}" style="width:120px;" disabled />
                    </td>
                    <td>
                      <div style="font-weight:850;">{{ format_stock(ing.stock_qty_base or 0, ing.unit) }}</div>
                      <div class="mini">(základ: {{ ing.stock_qty_base or 0 }} {{ unit_base_label(ing.unit) }})</div>
                    </td>
                    <td>
                        <div class="ingredients-actions">
                          {% if not readonly %}
                            <button class="btn ingredient-edit-btn" type="button">Změna</button>
                            <button class="btn solid ingredient-save-btn" type="submit">Uložit</button>
                            <div class="ingredient-file">
                              <input class="input" type="file" name="pictogram" accept="image/*" style="max-width:160px;" />
                            </div>
                          {% else %}
                            <div class="mini">—</div>
                          {% endif %}
                        </div>
                      </form>

                      {% if not readonly %}
                        <form method="post" action="{{ inventory_base_path }}/ingredient/{{ ing.id }}/delete" style="display:inline;margin-left:8px;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                          <button class="btn" type="submit" onclick="return confirm('Opravdu smazat surovinu?');">Smazat</button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const search = document.getElementById("ingredient-search");
          const rows = document.querySelectorAll(".ingredient-row");
          if (search) {
            search.addEventListener("input", () => {
              const q = search.value.trim().toLowerCase();
              rows.forEach((row) => {
                const hay = row.dataset.search || "";
                row.style.display = !q || hay.includes(q) ? "" : "none";
              });
            });
          }

          document.querySelectorAll(".ingredient-row").forEach((row) => {
            const editBtn = row.querySelector(".ingredient-edit-btn");
            const fields = row.querySelectorAll(".ingredient-field");
            if (!editBtn) {
              return;
            }
            editBtn.addEventListener("click", () => {
              row.classList.add("ingredient-editing");
              fields.forEach((field) => {
                field.removeAttribute("disabled");
              });
            });
          });
        });
      </script>
    </main>
  </div>
</div>
{% endblock %}
