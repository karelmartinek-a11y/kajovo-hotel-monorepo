{% extends "base.html" %}

{% set use_sidebar = true %}

{% block sidebar %}
  {% include "admin_sidebar.html" %}
{% endblock %}

{% block title %}KájovoHotel — Detail záznamu{% endblock %}

{% block head_extra %}{% endblock %}

{% block body_content %}
<div class="page">
  <div class="container admin-shell">
    {% include "admin_sidebar.html" %}

    <main class="admin-main">
      <div class="stack" style="gap:14px;">
        <div class="row" style="justify-content:space-between;align-items:flex-end;flex-wrap:wrap;">
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div style="font-size:20px;font-weight:850;">Detail záznamu</div>
            <div style="color:var(--muted);">Pokoj {{ report.room }} • ID {{ report.id }}</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
            <a href="/admin/reports" class="btn">Zpět na seznam</a>
          </div>
        </div>

        <div class="card pad" style="display:grid;gap:14px;">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            {% if report.type == "FIND" %}
              <span class="badge" style="background:#e0f2fe;border-color:#bae6fd;">Ztráty a nálezy</span>
            {% else %}
              <span class="badge" style="background:#fef3c7;border-color:#fde68a;">Závady</span>
            {% endif %}
            {% if report.status == "OPEN" %}
              <span class="badge active"><span class="b-dot" aria-hidden="true"></span><span>OPEN</span></span>
            {% else %}
              <span class="badge"><span class="b-dot" aria-hidden="true"></span><span>DONE</span></span>
            {% endif %}
          </div>

          <div style="display:grid;gap:8px;">
            <div style="display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:13px;">
              <div><strong>Vytvořeno:</strong> {{ report.created_at_human }}</div>
              <div><strong>Vyřízeno:</strong> {{ report.done_at_human or "—" }}</div>
              <div><strong>Doba:</strong> {% if report.duration_hours is not none %}{{ '%.1f'|format(report.duration_hours) }} h{% else %}—{% endif %}</div>
              <div><strong>Zdroj:</strong> web portál</div>
            </div>
            <div class="card pad" style="background:#f8fafc;border-color:var(--line);">
              <div style="font-size:13px;color:var(--muted);">Popis</div>
              <div style="margin-top:6px;font-size:15px;">{{ report.description or "(bez popisu)" }}</div>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            {% if report.status == "OPEN" %}
            <form method="post" action="/admin/reports/{{ report.id }}/done">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button type="submit" class="btn solid">Vyřízeno</button>
            </form>
            {% else %}
            <form method="post" action="/admin/reports/{{ report.id }}/reopen">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button type="submit" class="btn">Reopen</button>
            </form>
            {% endif %}
            <form method="post" action="/admin/reports/{{ report.id }}/delete" onsubmit="return confirm('Opravdu smazat tento záznam včetně fotek?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button type="submit" class="btn danger">Smazat</button>
            </form>
          </div>

          <div class="card pad" style="background:#f8fafc;border-color:var(--line);display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
            <div>
              <div class="label">ID</div>
              <div style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;">{{ report.id }}</div>
            </div>
            <div>
              <div class="label">Fotky</div>
              <div style="font-weight:700;">{{ report.photo_count }}</div>
            </div>
            {% if report.done_at_human %}
            <div>
              <div class="label">Vyřízeno</div>
              <div>{{ report.done_at_human }}</div>
            </div>
            {% endif %}
            {% if report.duration_hours is not none %}
            <div>
              <div class="label">Doba vyřízení</div>
              <div>{{ '%.1f'|format(report.duration_hours) }} h</div>
            </div>
            {% endif %}
            <div>
              <div class="label">Vyřídil</div>
              <div style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;">{{ report.done_by_device_id or '—' }}</div>
            </div>
          </div>
        </div>

        <div class="card pad" style="display:grid;gap:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div style="font-weight:800;">Fotky</div>
            <div style="color:var(--muted);font-size:13px;">Kliknutím otevřete</div>
          </div>
          {% if photos and photos|length > 0 %}
            <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));">
              {% for p in photos %}
                <a href="/admin/media/{{ p.id }}/original" target="_blank" rel="noopener" class="card pad" style="padding:8px;">
                  <div style="aspect-ratio:1/1;background:#f8fafc;border-radius:12px;overflow:hidden;border:1px solid var(--line);display:grid;place-items:center;">
                    <img src="/admin/media/{{ p.id }}/thumb" alt="Foto" style="width:100%;height:100%;object-fit:cover;" loading="lazy" />
                  </div>
                  <div style="margin-top:6px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;">
                    <span class="font-mono">{{ loop.index }} / {{ photos|length }}</span>
                    <span class="font-mono">{{ p.size_kb }} KB</span>
                  </div>
                </a>
              {% endfor %}
            </div>
            <div style="font-size:12px;color:var(--muted);">Originály a miniatury jsou dostupné pouze po přihlášení (admin session).</div>
          {% else %}
            <div style="padding:14px;color:var(--muted);border:1px solid var(--line);border-radius:12px;">Tento záznam nemá žádné fotky.</div>
          {% endif %}
        </div>

        <div class="card pad" style="display:grid;gap:12px;">
          <div style="font-weight:800;">Historie (audit)</div>
          {% if history and history|length > 0 %}
            <div style="display:grid;gap:10px;">
              {% for h in history %}
              <div class="card pad" style="padding:10px;border-color:var(--line);">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <div style="font-weight:700;">{{ h.action_label }}</div>
                  <div style="font-size:12px;color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;">{{ h.at_human }}</div>
                </div>
                <div style="margin-top:6px;font-size:12px;color:var(--muted);">
                  {% if h.by_admin %}
                    admin
                  {% else %}
                    uživatel
                  {% endif %}
                  {% if h.note %}
                    <span style="margin:0 8px;color:var(--muted);">|</span>
                    {{ h.note }}
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div style="padding:12px;color:var(--muted);border:1px solid var(--line);border-radius:12px;">Zatím bez historie.</div>
          {% endif %}
        </div>

        <div class="card pad">
          <div style="font-weight:700;">Poznámka</div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px;">
            Fotografie jsou na serveru uložené na disku a nejsou veřejně přístupné. Admin rozhraní je zobrazuje přes chráněné endpointy.
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
{% endblock %}
